{% extends 'base.html' %}
{% load static %}

{% block title %}Select Seats - {{ showtime.movie.title }}{% endblock %}

{% block content %}
<style>
    /* Screen & Map Styles */
    .screen { background-color: #fff; height: 6px; width: 100%; margin: 0 auto 40px; box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); border-radius: 5px; position: relative; }
    .screen::after { content: "SCREEN"; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; letter-spacing: 2px; color: #888; }
    .seats-grid { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .row { display: flex; gap: 8px; justify-content: center; align-items: center; }
    .row-label { color: #9ca3af; font-weight: bold; width: 20px; text-align: center; }
    
    /* Checkbox Hiding & Label Styling */
    .seat-checkbox { display: none; }
    .seat-label { width: 32px; height: 32px; background-color: #374151; border-radius: 6px 6px 2px 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #d1d5db; user-select: none; transition: all 0.2s; border: 1px solid #4b5563; position: relative; }
    .seat-label:hover { background-color: #4b5563; transform: translateY(-2px); }
    .seat-checkbox:checked + .seat-label { background-color: #4f46e5; color: white; border-color: #6366f1; box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); }
    
    /* Legend */
    .legend { display: flex; justify-content: center; gap: 20px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #374151; font-size: 0.85rem; color: #d1d5db; }
    .legend-item { display: flex; align-items: center; gap: 8px; }
    .seat-sample { width: 16px; height: 16px; display: inline-block; border-radius: 2px; }
    
    /* Quantity Counters CSS */
    .qty-input { background: transparent; border: none; color: white; text-align: center; width: 30px; font-weight: bold; }
    /* Hides spinner arrows on number input */
    .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .qty-btn { background-color: #4b5563; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: background 0.2s; }
    .qty-btn:hover { background-color: #6b7280; }
    .seat-occupied {
        background-color: #dc2626 !important; /* Red */
        border-color: #991b1b !important;     /* Dark Red */
        color: white !important;
        cursor: not-allowed !important;
        opacity: 0.6;
        box-shadow: none !important;
    }
</style>

<div class="w-full max-w-screen-xl mx-auto px-2 sm:px-4 md:px-8 py-10">

    <div class="max-w-4xl mx-auto text-center mb-10">
        <h1 class="text-4xl font-extrabold text-white mb-2">Select Your Seats</h1>
        <p class="text-gray-400">Step 2 of 3</p>
    </div>

    <form method="post" action="{% url 'viewer:book_seat' showtime.pk %}" id="bookingForm">
        {% csrf_token %}

        <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="md:col-span-1 space-y-6">
                
                <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700 sticky top-4">
                    <div class="p-5 border-b border-gray-700">
                        <h2 class="text-xl font-bold text-white leading-tight">{{ showtime.movie.title }}</h2>
                        <div class="text-gray-400 text-xs mt-2">
                            <p>{{ showtime.cinema.name }}</p>
                            <p>{{ showtime.show_time|date:"D, M d" }} @ {{ showtime.show_time|time:"g:i A" }}</p>
                        </div>
                    </div>

                    <div class="p-5">
                        <h3 class="text-lg font-bold text-white mb-4">Select Tickets</h3>
                        <div class="space-y-4 text-sm">
                            
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="block text-white font-bold">Adult</span>
                                    <span class="text-xs text-gray-400">
                                        $ {% if is_weekend %}{{ showtime.cinema.adult_weekend_price }}{% else %}{{ showtime.cinema.Adult_ticket_price }}{% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center bg-gray-800 rounded p-1 border border-gray-600">
                                    <button type="button" class="qty-btn" onclick="updateQty('adult', -1)">-</button>
                                    <input type="number" name="adult_qty" id="adult_qty" value="0" min="0" class="qty-input" readonly 
                                           data-price="{% if is_weekend %}{{ showtime.cinema.adult_weekend_price }}{% else %}{{ showtime.cinema.Adult_ticket_price }}{% endif %}">
                                    <button type="button" class="qty-btn" onclick="updateQty('adult', 1)">+</button>
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="block text-white font-bold">Child</span>
                                    <span class="text-xs text-gray-400">
                                        $ {% if is_weekend %}{{ showtime.cinema.child_weekend_price }}{% else %}{{ showtime.cinema.Child_ticket_price }}{% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center bg-gray-800 rounded p-1 border border-gray-600">
                                    <button type="button" class="qty-btn" onclick="updateQty('child', -1)">-</button>
                                    <input type="number" name="child_qty" id="child_qty" value="0" min="0" class="qty-input" readonly
                                           data-price="{% if is_weekend %}{{ showtime.cinema.child_weekend_price }}{% else %}{{ showtime.cinema.Child_ticket_price }}{% endif %}">
                                    <button type="button" class="qty-btn" onclick="updateQty('child', 1)">+</button>
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="block text-white font-bold">Senior</span>
                                    <span class="text-xs text-gray-400">
                                        $ {% if is_weekend %}{{ showtime.cinema.senior_weekend_price }}{% else %}{{ showtime.cinema.Senior_ticket_price }}{% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center bg-gray-800 rounded p-1 border border-gray-600">
                                    <button type="button" class="qty-btn" onclick="updateQty('senior', -1)">-</button>
                                    <input type="number" name="senior_qty" id="senior_qty" value="0" min="0" class="qty-input" readonly
                                           data-price="{% if is_weekend %}{{ showtime.cinema.senior_weekend_price }}{% else %}{{ showtime.cinema.Senior_ticket_price }}{% endif %}">
                                    <button type="button" class="qty-btn" onclick="updateQty('senior', 1)">+</button>
                                </div>
                            </div>

                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="block text-white font-bold">Student</span>
                                    <span class="text-xs text-gray-400">
                                        $ {% if is_weekend %}{{ showtime.cinema.student_weekend_price }}{% else %}{{ showtime.cinema.Student_ticket_price }}{% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center bg-gray-800 rounded p-1 border border-gray-600">
                                    <button type="button" class="qty-btn" onclick="updateQty('student', -1)">-</button>
                                    <input type="number" name="student_qty" id="student_qty" value="0" min="0" class="qty-input" readonly
                                           data-price="{% if is_weekend %}{{ showtime.cinema.student_weekend_price }}{% else %}{{ showtime.cinema.Student_ticket_price }}{% endif %}">
                                    <button type="button" class="qty-btn" onclick="updateQty('student', 1)">+</button>
                                </div>
                            </div>

                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-700">
                            <div class="flex justify-between items-center text-xl font-bold text-emerald-400">
                                <span>Total:</span>
                                <span id="total-display">$0.00</span>
                            </div>
                            <p id="seat-warning" class="text-xs text-red-400 mt-2 hidden">
                                Select <span id="seats-needed">0</span> more seat(s).
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2">
                <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg border border-gray-700 p-6 sm:p-8 h-full flex flex-col justify-between">
                    
                    <div>
                        <h3 class="text-xl font-bold text-white mb-8 border-b border-gray-700 pb-4">Screen A - Seating Chart</h3>
                        <div class="px-8"><div class="screen"></div></div>

                        <div class="seats-grid">
                            {% for row in "ABCD"|make_list %}
                            <div class="row">
                                <span class="row-label">{{ row }}</span>
                                {% for i in "12345678"|make_list %}
                                    {% with seat_id=row|add:i %}
                                        {% if seat_id in taken_seats %}
                                            <div class="seat-label seat-occupied" title="Occupied">{{ seat_id }}</div>
                                        {% else %}
                                            <input type="checkbox" id="seat-{{ seat_id }}" name="seats" value="{{ seat_id }}" class="seat-checkbox" onchange="updateValidation()">
                                            <label for="seat-{{ seat_id }}" class="seat-label" title="Seat {{ seat_id }}">{{ seat_id }}</label>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>

                        <div class="legend">
                            <div class="legend-item"><span class="seat-sample" style="background-color: #374151; border: 1px solid #4b5563;"></span> Available</div>
                            <div class="legend-item"><span class="seat-sample" style="background-color: #4f46e5;"></span> Selected</div>
                            <div class="legend-item opacity-50"><span class="seat-sample" style="background-color: #ef4444;"></span> Occupied</div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 mt-6 border-t border-gray-700 pt-6">
                        <a href="{% url 'viewer:cinema_prices' showtime.movie.pk %}" class="flex-1 text-center py-3 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-800 transition">Cancel</a>
                        
                        <button type="submit" id="confirm-btn" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/30 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Confirm Selection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Get values safely
    function getVal(id) { return parseInt(document.getElementById(id).value) || 0; }
    function getPrice(id) { return parseFloat(document.getElementById(id).dataset.price) || 0; }

    // Update Quantity Counter
    function updateQty(type, change) {
        const input = document.getElementById(type + '_qty');
        let newVal = parseInt(input.value) + change;
        if (newVal < 0) newVal = 0;
        input.value = newVal;
        updateValidation();
    }

    // Main Logic: Validates that Tickets == Seats
    function updateValidation() {
        // 1. Calculate Total Tickets Needed
        const adultQty = getVal('adult_qty');
        const childQty = getVal('child_qty');
        const seniorQty = getVal('senior_qty');
        const studentQty = getVal('student_qty');
        const totalTickets = adultQty + childQty + seniorQty + studentQty;

        // 2. Calculate Seats Actually Clicked
        const selectedSeats = document.querySelectorAll('.seat-checkbox:checked').length;

        // 3. Calculate Real-Time Price
        const totalCost = (adultQty * getPrice('adult_qty')) + 
                          (childQty * getPrice('child_qty')) + 
                          (seniorQty * getPrice('senior_qty')) + 
                          (studentQty * getPrice('student_qty'));
        
        document.getElementById('total-display').innerText = '$' + totalCost.toFixed(2);

        // 4. Logic to Enable/Disable Button
        const warning = document.getElementById('seat-warning');
        const btn = document.getElementById('confirm-btn');
        const seatsNeededSpan = document.getElementById('seats-needed');

        // If 0 tickets, disable
        if (totalTickets === 0) {
            btn.disabled = true;
            warning.classList.add('hidden');
            return;
        }

        const diff = totalTickets - selectedSeats;

        if (diff === 0) {
            // Success: Tickets match Seats
            btn.disabled = false;
            warning.classList.add('hidden');
        } else if (diff > 0) {
            // User needs to click more seats
            btn.disabled = true;
            warning.classList.remove('hidden');
            seatsNeededSpan.innerText = diff;
            warning.innerText = `Please select ${diff} more seat(s) on the map.`;
        } else {
            // User clicked too many seats
            btn.disabled = true;
            warning.classList.remove('hidden');
            warning.innerText = `You selected too many seats! Remove ${Math.abs(diff)}.`;
        }
    }
</script>
{% endblock %}