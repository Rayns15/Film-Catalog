{% extends 'base.html' %}
{% load static %}

{% block title %}Select Seats - {{ showtime.movie.title }}{% endblock %}

{% block content %}
<style>
    /* --- Custom Styles for the Seat Grid --- */
    
    /* The Screen visual effect */
    .screen { 
        background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0));
        height: 30px; 
        width: 80%; 
        margin: 0 auto 30px; 
        transform: perspective(400px) rotateX(-10deg);
        box-shadow: 0 15px 20px -10px rgba(255, 255, 255, 0.3); 
        border-radius: 5px; 
        opacity: 0.5;
    }

    /* The Seat Checkbox Hack: Hide the real checkbox, style the label */
    .seat-checkbox { display: none; }
    
    .seat-label { 
        width: 36px; 
        height: 36px; 
        background-color: #374151; /* gray-700 */
        border-radius: 6px 6px 4px 4px; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 0.75rem; 
        color: #9ca3af; 
        transition: all 0.2s; 
        border-top: 2px solid #4b5563;
    }

    /* Hover State */
    .seat-label:hover { background-color: #4b5563; color: white; transform: scale(1.1); }

    /* CHECKED State */
    .seat-checkbox:checked + .seat-label { 
        background-color: #4f46e5; /* indigo-600 */
        border-top-color: #818cf8; /* indigo-400 */
        color: white; 
        box-shadow: 0 0 10px rgba(79, 70, 229, 0.6); 
    }

    /* OCCUPIED State (Others) */
    .seat-occupied {
        background-color: #7f1d1d !important; /* red-900 */
        border-top-color: #991b1b !important;
        color: #fca5a5 !important;
        cursor: not-allowed !important;
        opacity: 0.7;
        pointer-events: none; 
    }

    /* MY SEATS State (Yours) */
    .seat-mine {
        background-color: #d97706 !important; /* Amber-600 */
        border-top-color: #f59e0b !important; /* Amber-500 */
        color: white !important;
        cursor: not-allowed !important;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        pointer-events: none;
    }

    /* Custom Scrollbar for Booking History */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    /* Input Spinners Removal */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
</style>

<div class="w-full max-w-screen-xl mx-auto px-4 py-10 min-h-screen">

    <div class="text-center mb-10">
        <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-2">Select Your Seats</h1>
        <p class="text-gray-400">Step 2 of 3</p>
    </div>

    <form method="post" action="{% url 'viewer:booking' showtime.pk %}" id="bookingForm" autocomplete="off">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="bg-gray-800/60 backdrop-blur-md rounded-2xl shadow-xl border border-gray-700 overflow-hidden sticky top-5 z-10">
                    
                    <div class="p-6 border-b border-gray-700 bg-gray-900/50">
                        <h2 class="text-xl font-bold text-white">{{ showtime.movie.title }}</h2>
                        <div class="text-gray-400 text-sm mt-1 flex justify-between">
                            <span>{{ showtime.cinema.name }}</span>
                            <span>{{ showtime.show_time|date:"D, M d â€¢ H:i" }}</span>
                        </div>
                    </div>

                    <div class="p-6 space-y-5">
                        <h3 class="text-sm uppercase tracking-wider text-gray-500 font-bold mb-4">Select Tickets</h3>

                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-white">Adult</div>
                                <div class="text-xs text-cyan-400 font-mono">
                                    ${% if is_weekend %}{{ showtime.cinema.adult_weekend_price }}{% else %}{{ showtime.cinema.Adult_ticket_price }}{% endif %}
                                </div>
                            </div>
                            <div class="flex items-center bg-gray-900 rounded-lg p-1 border border-gray-600">
                                <button type="button" class="w-8 h-8 rounded bg-gray-700 text-white hover:bg-gray-600 transition" onclick="changeQty('adult', -1)">-</button>
                                <input type="number" name="adult_qty" id="adult_qty" value="0" min="0" class="w-12 bg-transparent text-center text-white font-bold outline-none" readonly 
                                       data-price="{% if is_weekend %}{{ showtime.cinema.adult_weekend_price }}{% else %}{{ showtime.cinema.Adult_ticket_price }}{% endif %}">
                                <button type="button" class="w-8 h-8 rounded bg-indigo-600 text-white hover:bg-indigo-500 transition" onclick="changeQty('adult', 1)">+</button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-white">Child</div>
                                <div class="text-xs text-cyan-400 font-mono">
                                    ${% if is_weekend %}{{ showtime.cinema.child_weekend_price }}{% else %}{{ showtime.cinema.Child_ticket_price }}{% endif %}
                                </div>
                            </div>
                            <div class="flex items-center bg-gray-900 rounded-lg p-1 border border-gray-600">
                                <button type="button" class="w-8 h-8 rounded bg-gray-700 text-white hover:bg-gray-600 transition" onclick="changeQty('child', -1)">-</button>
                                <input type="number" name="child_qty" id="child_qty" value="0" min="0" class="w-12 bg-transparent text-center text-white font-bold outline-none" readonly
                                       data-price="{% if is_weekend %}{{ showtime.cinema.child_weekend_price }}{% else %}{{ showtime.cinema.Child_ticket_price }}{% endif %}">
                                <button type="button" class="w-8 h-8 rounded bg-indigo-600 text-white hover:bg-indigo-500 transition" onclick="changeQty('child', 1)">+</button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-white">Senior</div>
                                <div class="text-xs text-cyan-400 font-mono">
                                    ${% if is_weekend %}{{ showtime.cinema.senior_weekend_price }}{% else %}{{ showtime.cinema.Senior_ticket_price }}{% endif %}
                                </div>
                            </div>
                            <div class="flex items-center bg-gray-900 rounded-lg p-1 border border-gray-600">
                                <button type="button" class="w-8 h-8 rounded bg-gray-700 text-white hover:bg-gray-600 transition" onclick="changeQty('senior', -1)">-</button>
                                <input type="number" name="senior_qty" id="senior_qty" value="0" min="0" class="w-12 bg-transparent text-center text-white font-bold outline-none" readonly
                                       data-price="{% if is_weekend %}{{ showtime.cinema.senior_weekend_price }}{% else %}{{ showtime.cinema.Senior_ticket_price }}{% endif %}">
                                <button type="button" class="w-8 h-8 rounded bg-indigo-600 text-white hover:bg-indigo-500 transition" onclick="changeQty('senior', 1)">+</button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-white">Student</div>
                                <div class="text-xs text-cyan-400 font-mono">
                                    ${% if is_weekend %}{{ showtime.cinema.student_weekend_price }}{% else %}{{ showtime.cinema.Student_ticket_price }}{% endif %}
                                </div>
                            </div>
                            <div class="flex items-center bg-gray-900 rounded-lg p-1 border border-gray-600">
                                <button type="button" class="w-8 h-8 rounded bg-gray-700 text-white hover:bg-gray-600 transition" onclick="changeQty('student', -1)">-</button>
                                <input type="number" name="student_qty" id="student_qty" value="0" min="0" class="w-12 bg-transparent text-center text-white font-bold outline-none" readonly
                                       data-price="{% if is_weekend %}{{ showtime.cinema.student_weekend_price }}{% else %}{{ showtime.cinema.Student_ticket_price }}{% endif %}">
                                <button type="button" class="w-8 h-8 rounded bg-indigo-600 text-white hover:bg-indigo-500 transition" onclick="changeQty('student', 1)">+</button>
                            </div>
                        </div>

                        <div class="mt-8 pt-4 border-t border-gray-600 flex justify-between items-end">
                            <span class="text-gray-400 text-sm">Total Cost</span>
                            <span class="text-2xl font-bold text-emerald-400" id="total-price">$0.00</span>
                        </div>
                    </div>
                </div>

                {% if user_bookings %}
                <div class="bg-indigo-900/40 backdrop-blur-md rounded-2xl shadow-xl border border-indigo-500/30 overflow-hidden mt-6">
                    <div class="p-5 border-b border-indigo-500/30 bg-indigo-900/50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Your Bookings</h3>
                        <span class="text-xs bg-indigo-600 text-white px-2 py-1 rounded-full">{{ user_bookings.count }} Order(s)</span>
                    </div>
                    
                    <div class="p-5 space-y-4 max-h-80 overflow-y-auto custom-scrollbar">
                        {% for booking in user_bookings %}
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700 relative group transition hover:border-indigo-500">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="text-xs text-gray-400 uppercase tracking-wide">Seats</span>
                                    <div class="text-white font-bold text-lg tracking-widest text-emerald-400">
                                        {{ booking.seats }}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-gray-400 uppercase tracking-wide">Paid</span>
                                    <div class="text-white font-bold">${{ booking.total_cost }}</div>
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-500 mb-3">
                                Booked on: {{ booking.created_at|date:"M d, Y" }}
                            </div>

                            <a href="{% url 'viewer:booking_cancel' booking.pk %}" 
                               class="block w-full text-center py-2 rounded bg-red-900/30 text-red-300 border border-red-900/50 hover:bg-red-600 hover:text-white transition text-sm font-semibold">
                                Cancel Booking
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

            </div>

            <div class="lg:col-span-8">
                <div class="bg-gray-800/60 backdrop-blur-md rounded-2xl shadow-xl border border-gray-700 p-8 flex flex-col items-center h-full relative">
                    
                    <h3 class="text-gray-400 text-sm font-bold tracking-[0.2em] mb-8">SCREEN</h3>
                    
                    <div class="screen"></div>

                    <div class="flex flex-col gap-3 mb-10">
                        {% for row in "ABCD"|make_list %}
                        <div class="flex items-center gap-3">
                            <div class="w-6 text-gray-500 font-bold text-center">{{ row }}</div>

                            {% for col in "12345678"|make_list %}
                                {% with seat_id=row|add:col %}
                                    
                                    <div class="relative group">
                                        {% if seat_id in my_seats %}
                                            <div class="seat-label seat-mine" title="Your Seat">
                                                {{ seat_id }}
                                            </div>

                                        {% elif seat_id in taken_seats %}
                                            <div class="seat-label seat-occupied" title="Occupied">
                                                {{ seat_id }}
                                            </div>

                                        {% else %}
                                            <input type="checkbox" name="seats" value="{{ seat_id }}" id="seat-{{ seat_id }}" class="seat-checkbox" onchange="validateForm()">
                                            <label for="seat-{{ seat_id }}" class="seat-label">
                                                {{ seat_id }}
                                            </label>
                                        {% endif %}
                                    </div>

                                {% endwith %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>

                    <div class="flex flex-wrap justify-center gap-6 text-sm text-gray-400 mb-8 border-t border-gray-700 pt-6 w-full">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-gray-500 rounded border border-gray-400"></div> Available
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-indigo-600 rounded shadow-sm"></div> Selected
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-amber-600 rounded border border-amber-500"></div> Yours
                        </div>

                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-red-900 rounded opacity-70"></div> Occupied
                        </div>
                    </div>

                    <div id="validation-msg" class="w-full text-center bg-red-500/10 border border-red-500/50 text-red-200 px-4 py-2 rounded-lg text-sm mb-6 hidden">
                        Please select seats to match your tickets.
                    </div>

                    <div class="w-full flex gap-4 mt-auto">
                        <a href="{% url 'viewer:cinema_prices' showtime.movie.pk %}" class="flex-1 py-3 border border-gray-600 rounded-xl text-center text-gray-300 hover:bg-gray-700 transition font-semibold">Cancel</a>
                        <button type="submit" id="submit-btn" class="flex-1 py-3 bg-gray-600 text-gray-300 rounded-xl font-bold cursor-not-allowed transition" disabled>Confirm Booking</button>
                    </div>

                </div>
            </div>

        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getPrice(id) {
        const el = document.getElementById(id);
        return el ? parseFloat(el.getAttribute('data-price')) : 0;
    }

    function changeQty(type, delta) {
        const input = document.getElementById(type + '_qty');
        let currentVal = parseInt(input.value) || 0;
        let newVal = currentVal + delta;
        if (newVal < 0) newVal = 0;
        input.value = newVal;
        validateForm(); 
    }

    function validateForm() {
        const adult = parseInt(document.getElementById('adult_qty').value) || 0;
        const child = parseInt(document.getElementById('child_qty').value) || 0;
        const senior = parseInt(document.getElementById('senior_qty').value) || 0;
        const student = parseInt(document.getElementById('student_qty').value) || 0;
        const totalTickets = adult + child + senior + student;

        const checkboxes = document.querySelectorAll('.seat-checkbox:checked');
        const totalSeats = checkboxes.length;

        const totalCost = (adult * getPrice('adult_qty')) + 
                          (child * getPrice('child_qty')) + 
                          (senior * getPrice('senior_qty')) + 
                          (student * getPrice('student_qty'));
        
        document.getElementById('total-price').innerText = '$' + totalCost.toFixed(2);

        const btn = document.getElementById('submit-btn');
        const msg = document.getElementById('validation-msg');

        if (totalTickets === 0) {
            btn.disabled = true;
            btn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'cursor-pointer', 'shadow-lg');
            btn.classList.add('bg-gray-600', 'text-gray-300', 'cursor-not-allowed');
            msg.innerText = "Please select at least one ticket.";
            msg.classList.remove('hidden');
        } 
        else if (totalTickets !== totalSeats) {
            btn.disabled = true;
            btn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'cursor-pointer', 'shadow-lg');
            btn.classList.add('bg-gray-600', 'text-gray-300', 'cursor-not-allowed');
            
            const diff = totalTickets - totalSeats;
            if (diff > 0) {
                msg.innerText = `Select ${diff} more seat(s) on the map.`;
            } else {
                msg.innerText = `You selected too many seats. Uncheck ${Math.abs(diff)}.`;
            }
            msg.classList.remove('hidden');
        } 
        else {
            btn.disabled = false;
            btn.classList.remove('bg-gray-600', 'text-gray-300', 'cursor-not-allowed');
            btn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'cursor-pointer', 'shadow-lg');
            msg.classList.add('hidden');
        }
    }
</script>
{% endblock %}