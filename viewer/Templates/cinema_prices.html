{% extends 'base.html' %}
{% load static %}

{% block title %}{{ movie.title }} - Prices & Showtimes{% endblock %}

{% block content %}
<div class="w-full max-w-screen-xl mx-auto px-2 sm:px-4 md:px-8 py-10">

    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-12">
        <h1 class="text-4xl font-extrabold text-white text-center">
            <span class='bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 text-transparent'>Ticket Prices</span>
        </h1>
    </div>

    <div class="max-w-5xl mx-auto space-y-8">
        
        {% if cinemas_with_showtimes %}
            {% for cinema in cinemas_with_showtimes %}
            <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700">
                
                <div class="p-4 bg-gray-800/70 flex flex-col sm:flex-row sm:justify-between sm:items-center">
                    <div>
                        <h3 class="text-2xl font-bold text-cyan-300">{{ cinema.name }}</h3>
                        <p class="text-sm font-normal text-gray-400">{{ cinema.location }}</p>
                    </div>
                    {% if user.is_staff %}
                        <a href="{% url 'viewer:cinema_prices_update' cinema.pk %}?next={{ request.path }}" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition text-sm font-medium mt-2 sm:mt-0 self-start sm:self-center">
                            Update Prices
                        </a>
                    {% endif %}
                </div>

                <ul class="divide-y divide-gray-700 p-6 text-white">
                    <li class="grid grid-cols-3 gap-4 pb-3">
                        <span class="font-medium text-cyan-300">Ticket Type</span>
                        <span class="font-medium text-cyan-300 text-right">Weekday</span>
                        <span class="font-medium text-cyan-300 text-right">Weekend</span>
                    </li>
                    
                    <li class="grid grid-cols-3 gap-4 py-3">
                        <span>Adult <span class="text-gray-400 text-sm">(13-64)</span></span>
                        <span class="font-semibold text-right">${{ cinema.Adult_ticket_price|default:"0.00"|floatformat:2 }}</span>
                        <span class="font-semibold text-right">${{ cinema.adult_weekend_price|default:"0.00"|floatformat:2 }}</span>
                    </li>
                    
                    <li class="grid grid-cols-3 gap-4 py-3">
                        <span>Child <span class="text-gray-400 text-sm">(3-12)</span></span>
                        <span class="font-semibold text-right">${{ cinema.Child_ticket_price|default:"0.00"|floatformat:2 }}</span>
                        <span class="font-semibold text-right">${{ cinema.child_weekend_price|default:"0.00"|floatformat:2 }}</span>
                    </li>

                    <li class="grid grid-cols-3 gap-4 py-3">
                        <span>Senior <span class="text-gray-400 text-sm">(65+)</span></span>
                        <span class="font-semibold text-right">${{ cinema.Senior_ticket_price|default:"0.00"|floatformat:2 }}</span>
                        <span class="font-semibold text-right">${{ cinema.senior_weekend_price|default:"0.00"|floatformat:2 }}</span>
                    </li>

                    <li class="grid grid-cols-3 gap-4 py-3">
                        <span>Student <span class="text-gray-400 text-sm">(with valid ID)</span></span>
                        <span class="font-semibold text-right">${{ cinema.Student_ticket_price|default:"0.00"|floatformat:2 }}</span>
                        <span class="font-semibold text-right">${{ cinema.student_weekend_price|default:"0.00"|floatformat:2 }}</span>
                    </li>
                </ul>

            </div>
            {% endfor %}
            
        {% else %}
            <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700">
                <p class="text-white text-center p-10 text-lg">
                    Pricing information is not available because no cinemas are currently scheduled to show this movie.
                </p>
            </div>
        {% endif %}
    </div>

    <h2 class="text-3xl font-bold text-white mt-16 mb-8 text-center">
        <span class='bg-clip-text bg-gradient-to-r from-emerald-400 to-green-400 text-transparent'>Upcoming Showtimes for {{ movie.title }}</span>
    </h2>

    <div class="max-w-5xl mx-auto bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700 mb-8 md:flex">
        
        <div class="md:w-1/3">
            {% if movie.profile_picture %}
                <img src="{{ movie.profile_picture.url }}" alt="{{ movie.title }} Poster" class="h-full w-full object-cover">
            {% else %}
                <img src="{% static 'logos/placeholder.jpg' %}" alt="Placeholder" class="h-full w-full object-cover">
            {% endif %}
        </div>

        <div class="md:w-2/3 p-6">
            <h3 class="text-2xl font-bold text-white mb-2">Movie Details</h3>
            
            {% if movie.rating %}
            <div class="flex items-center mb-4" title="Rating: {{ movie.rating|floatformat:1 }}/5">
                <div class="relative flex items-center text-xl">
                    <div class="flex text-gray-400">
                        <span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
                    </div>
                    <div class="absolute top-0 left-0 overflow-hidden" style="width: {% widthratio movie.rating 5 100 %}%">
                        <div class="flex text-yellow-400">
                            <span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
                        </div>
                    </div>
                </div>
                <span class="text-white font-semibold ml-2 text-sm">
                    {{ movie.rating|floatformat:1|default:'N/A' }} / 5.0
                </span>
            </div>
            {% endif %}

            <ul class="text-gray-300 space-y-2 text-lg">
                <li>
                    <span class="font-semibold text-cyan-300">Directed by:</span> {{ movie.director|default:"N/A" }}
                </li>
                <li>
                    <span class="font-semibold text-cyan-300">Released in:</span> {{ movie.year|default:"N/A" }}
                </li>
                <li>
                    <span class="font-semibold text-cyan-300">Genre:</span> {{ movie.genre_movie|default:"N/A" }}
                </li>
            </ul>
        </div>
    </div>

    <div class="max-w-5xl mx-auto space-y-8">
        {% if cinemas_with_showtimes %}
            {% for cinema in cinemas_with_showtimes %}
                <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700">
                    
                    <h3 class="text-2xl font-bold text-cyan-300 p-4 bg-gray-800/70">
                        {{ cinema.name }}
                        <span class="block text-base font-normal text-gray-400 mt-1">{{ cinema.location }}</span>
                    </h3>
                    
                    <div class="p-6 space-y-4">
                        {% with showtimes=cinema.filtered_showtimes %}
                            {% if showtimes %}
                                <div class="flex flex-wrap gap-3 mt-2">
                                    {% for show in showtimes %}
                                        <a href="{% url 'viewer:booking' show.pk %}" 
                                        class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-500 transition-colors duration-200 shadow-md">
                                            {{ show.show_time|date:"D, M d" }} &nbsp;|&nbsp; {{ show.show_time|time:"g:i A" }}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-400">No upcoming showtimes for '{{ movie.title }}' are listed at this cinema.</p>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700">
                <p class="text-white text-center p-10 text-xl">
                    There are no upcoming showtimes scheduled for <strong>{{ movie.title }}</strong> at any cinema.
                </p>
            </div>
        {% endif %}
    </div>


    {% if cinemas_with_showtimes %}
    <h2 class="text-3xl font-bold text-white mt-16 mb-8 text-center">
        <span class='bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400 text-transparent'>Upgrades & Surcharges</span>
    </h2>

    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 text-white">
        {% for cinema in cinemas_with_showtimes %}
            <div class="bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg p-6 border border-gray-700">
                <h3 class="text-xl font-semibold mb-3 text-pink-300">{{ cinema.name }}</h3>
                <ul class="space-y-2 text-gray-300">
                    <li>Weekend Surcharge: <span class="font-bold text-white">${{ cinema.weekend_surcharge|default:"0.00"|floatformat:2 }}</span></li>
                    <li>Holiday Surcharge: <span class="font-bold text-white">${{ cinema.holiday_surcharge|default:"0.00"|floatformat:2 }}</span></li>
                    <li>Matinee Discount: <span class="font-bold text-white">-${{ cinema.matinee_discount|default:"0.00"|floatformat:2 }}</span></li>
                    <li>Weekday Discount: <span class="font-bold text-white">-${{ cinema.weekday_discount|default:"0.00"|floatformat:2 }}</span></li>
                </ul>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    
    <h2 class="text-3xl font-bold text-white mt-16 mb-8 text-center">
    <span class='bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400 text-transparent'>Live Chat & Reviews for {{ movie.title }}</span>
</h2>

<div class="max-w-5xl mx-auto bg-gray-900/50 backdrop-blur-md rounded-xl shadow-lg overflow-hidden border border-gray-700">
    
    <div id="chat-messages" class="p-6 h-72 overflow-y-auto space-y-4">
        {% for chat in chat_messages %}
            <div id="chat-message-{{ chat.pk }}" class="chat-message {% if chat.user == user %}text-right{% else %}text-left{% endif %}">
                <div class="inline-block p-3 rounded-lg
                    {% if chat.user == user %}
                        bg-indigo-600 text-white
                    {% else %}
                        bg-gray-700 text-gray-200
                    {% endif %}">
                    <strong class="block text-sm">
                        {{ chat.user.username }}
                        <span class="text-xs font-normal text-gray-300 ml-2">{{ chat.timestamp|date:"M d, g:i A" }}</span>
                        
                        {% if user.is_staff %}
                        <button 
                            class="chat-delete-btn ml-2 text-red-400 hover:text-red-300 font-bold"
                            data-message-id="{{ chat.pk }}"
                            title="Delete this message">
                            [X]
                        </button>
                        {% endif %}
                        </strong>
                    <p class="text-base mt-1">{{ chat.message }}</p>
                </div>
            </div>
        {% empty %}
            <p id="empty-chat-message" class="text-gray-400 text-center">No messages yet. Be the first to comment!</p>
        {% endfor %}
    </div>

    {% if user.is_authenticated %}
        <form id="chat-form" method="post" action="{% url 'viewer:post-chat-message' movie.pk %}" onsubmit="return false;" class="p-4 bg-gray-800/70 border-t border-gray-700 flex gap-3">
            {% csrf_token %}
            <input type="text" id="chat-message-input" name="message" placeholder="Write a message..." required autocomplete="off" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button type="button" id="chat-send-btn" class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-indigo-700 transition">
                Send
            </button>
        </form>
    {% else %}
        <div class="p-4 bg-gray-800/70 border-t border-gray-700 text-center">
            <p class="text-gray-400">
                You must be <a href="{% url 'viewer:login' %}?next={{ request.path }}" class="text-indigo-400 font-semibold hover:underline">logged in</a> to post a message.
            </p>
        </div>
    {% endif %}
</div>
</div> 
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. SETUP ---
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('chat-message-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const messagesContainer = document.getElementById('chat-messages');
    const emptyMessage = document.getElementById('empty-chat-message');

    // --- NEW: DEFINE JS VARIABLE ---
    const isStaff = {{ user.is_staff|yesno:"true,false" }};
    // --- END NEW ---

    // --- 2. CSRF TOKEN & HELPERS ---
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    const csrfToken = (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || getCookie('csrftoken');

    function scrollToBottom() {
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    scrollToBottom(); // Scroll on page load

    // --- 3. SEND MESSAGE FUNCTION ---
    function sendMessage() {
        if (!messageInput) return;
        const message = messageInput.value.trim();
        if (message === "") return; // Don't send empty messages

        const postUrl = `{% url 'viewer:post-chat-message' movie.pk %}`;

        fetch(postUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', 
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 'message': message }), // Send as JSON
            credentials: 'same-origin'
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (!ok || data.status !== 'ok') {
                throw new Error(data.message || 'Server error');
            }

            if (emptyMessage) emptyMessage.remove();

            // --- START: MODIFIED BLOCK (PATCH 1) ---
            const messageElement = document.createElement('div');
            messageElement.id = `chat-message-${data.message_id}`; 
            messageElement.classList.add('chat-message', 'text-right');
            
            // Check if user is staff using a JavaScript variable
            // (We set this variable at the top of the script)
            const deleteButtonHtml = `
                <button 
                    class="chat-delete-btn ml-2 text-red-400 hover:text-red-300 font-bold"
                    data-message-id="${data.message_id}"
                    title="Delete this message">
                    [X]
                </button>
            `;

            messageElement.innerHTML = `
                <div class="inline-block p-3 rounded-lg bg-indigo-600 text-white">
                    <strong class="block text-sm">
                        ${data.user}
                        <span class="text-xs font-normal text-gray-300 ml-2">${data.timestamp}</span>
                        
                        ${ isStaff ? deleteButtonHtml : '' }

                    </strong>
                    <p class="text-base mt-1">${data.message}</p>
                </div>
            `;
            // --- END: MODIFIED BLOCK (PATCH 1) ---

            messagesContainer.appendChild(messageElement);
            scrollToBottom();
            messageInput.value = '';
        })
        .catch(err => {
            console.error('Send Error:', err);
            alert('Error: ' + err.message);
        });
    }

    // --- 4. SEND EVENT LISTENERS ---
    
    // Listen for form submission
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
    }

    // Listen for send button click
    if (chatSendBtn) {
        chatSendBtn.addEventListener('click', function() {
            sendMessage();
        });
    }

    // Listen for 'Enter' key press in the input field
    if (messageInput) {
        messageInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // --- 5. DELETE EVENT LISTENER (Moved to the correct level) ---
    if (messagesContainer) {
        messagesContainer.addEventListener('click', function(e) {
            const target = e.target;
            
            if (target && target.classList.contains('chat-delete-btn')) {
                const messageId = target.dataset.messageId;
                
                if (!messageId || messageId === 'undefined') {
                    console.error("Cannot delete: messageId is undefined.");
                    return;
                }
                
                if (confirm('Are you sure you want to delete this message?')) {
                    const deleteUrl = `{% url 'viewer:delete-chat-message' 0 %}`.replace('0', messageId);

                    fetch(deleteUrl, {
                        method: 'POST', 
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, data })))
                    .then(({ ok, data }) => {
                        if (!ok || data.status !== 'ok') {
                            throw new Error(data.message || 'Server error');
                        }
                        
                        const node = document.getElementById(`chat-message-${messageId}`);
                        if (node) node.remove();
                    })
                    .catch(err => {
                        console.error('Delete Error:', err);
                        alert('Delete failed: ' + err.message);
                    });
                }
            }
        });
    }

}); // Closes DOMContentLoaded
</script>
{% endblock %}