{% extends 'base.html' %}
{% load static %}

{% block title %}{{ showtime.movie.title }} - Select Seats{% endblock %}

{% block content %}
<style>
    /* Screen Glow Effect */
    .screen-glow {
        box-shadow: 0 -20px 60px -10px rgba(255, 255, 255, 0.1);
        transform: perspective(600px) rotateX(20deg) scale(0.9);
    }

    /* Hide default checkbox */
    .seat-checkbox {
        display: none;
    }

    /* Seat Styles */
    .seat-label {
        height: 2rem;
        width: 2rem;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-block;
        position: relative;
    }

    /* Available Seat */
    .seat-label.available {
        background-color: #374151; /* gray-700 */
        border: 1px solid #4B5563;
    }
    .seat-label.available:hover {
        background-color: #60A5FA; /* blue-400 */
        border-color: #60A5FA;
        transform: scale(1.1);
    }

    /* Selected Seat */
    .seat-checkbox:checked + .seat-label {
        background-color: #10B981; /* emerald-500 */
        border-color: #10B981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    /* Occupied Seat */
    .seat-label.occupied {
        background-color: #EF4444; /* red-500 */
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>

<div class="w-full max-w-screen-xl mx-auto px-4 py-8 text-white">

    <a href="{% url 'viewer:showtime_list' %}" class="text-gray-400 hover:text-white flex items-center gap-2 mb-6 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Cinemas
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-2 space-y-8">
            
            <div class="bg-gray-900/60 backdrop-blur-md rounded-xl p-6 border border-gray-700 flex flex-col sm:flex-row gap-6">
                {% if showtime.movie.image %}
                    <img src="{{ showtime.movie.image.url }}" alt="{{ showtime.movie.title }}" class="w-32 h-48 object-cover rounded-lg shadow-lg border border-gray-600">
                {% else %}
                    <div class="w-32 h-48 bg-gray-800 rounded-lg flex items-center justify-center text-gray-600">No Img</div>
                {% endif %}
                
                <div class="flex-1">
                    <h1 class="text-3xl font-extrabold mb-2">
                        <span class="bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-400 text-transparent">
                            {{ showtime.movie.title }}
                        </span>
                    </h1>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-300 mb-4">
                        <span class="bg-gray-800 px-3 py-1 rounded-full border border-gray-600">
                            üìç {{ showtime.cinema.name }}
                        </span>
                        <span class="bg-gray-800 px-3 py-1 rounded-full border border-gray-600">
                            ‚è∞ {{ showtime.show_time|date:"D, M d" }} at {{ showtime.show_time|time:"g:i A" }}
                        </span>
                        <span class="bg-gray-800 px-3 py-1 rounded-full border border-gray-600">
                            üí≤ {{ showtime.price_per_seat }} / ticket
                        </span>
                    </div>
                    <p class="text-gray-400 text-sm line-clamp-3">{{ showtime.movie.description }}</p>
                </div>
            </div>

            <div class="bg-gray-900/80 rounded-xl p-8 border border-gray-700 shadow-2xl">
                
                <div class="flex justify-center gap-6 mb-10 text-sm text-gray-400">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-gray-700 border border-gray-600 rounded-t-sm"></div> Available
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-emerald-500 rounded-t-sm shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div> Selected
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-red-500 opacity-50 rounded-t-sm"></div> Sold
                    </div>
                </div>

                <div class="relative mb-12 w-3/4 mx-auto">
                    <div class="h-4 bg-white/20 rounded-full screen-glow"></div>
                    <p class="text-center text-xs text-gray-500 mt-4 tracking-[0.3em] uppercase">Screen</p>
                </div>

                <form id="booking-form" method="POST" action="{% url 'viewer:book_seat' showtime.id %}">
                    {% csrf_token %}
                    
                    <div class="flex flex-col gap-3 items-center overflow-x-auto pb-4">
                        {% for row in rows %} 
                        <div class="flex gap-2 items-center">
                            <span class="w-6 text-right text-gray-500 text-xs font-bold mr-2">{{ row.number }}</span>
                            
                            {% for seat in row.seats %}
                                <input 
                                    type="checkbox" 
                                    name="seats" 
                                    value="{{ seat.id }}" 
                                    id="seat-{{ seat.id }}" 
                                    class="seat-checkbox"
                                    data-price="{{ showtime.price_per_seat }}"
                                    data-label="{{ row.number }}{{ seat.number }}"
                                    {% if not seat.is_available %}disabled{% endif %}
                                >
                                <label 
                                    for="seat-{{ seat.id }}" 
                                    class="seat-label {% if not seat.is_available %}occupied{% else %}available{% endif %}"
                                    title="Row {{ row.number }} Seat {{ seat.number }}">
                                </label>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-gray-800 rounded-xl p-6 sticky top-6 border border-gray-700 shadow-xl">
                <h3 class="text-xl font-bold text-white mb-4">Booking Summary</h3>
                
                <div class="space-y-4 border-b border-gray-700 pb-4 mb-4">
                    <div class="flex justify-between text-gray-400 text-sm">
                        <span>Cinema</span>
                        <span class="text-white">{{ showtime.cinema.name }}</span>
                    </div>
                    <div class="flex justify-between text-gray-400 text-sm">
                        <span>Ticket Price</span>
                        <span class="text-white">${{ showtime.price_per_seat }}</span>
                    </div>
                </div>

                <div id="selected-seats-container" class="min-h-[60px] mb-4">
                    <p class="text-gray-500 text-sm italic" id="no-seats-msg">No seats selected</p>
                    <div class="flex flex-wrap gap-2" id="seats-display">
                        </div>
                </div>

                <div class="flex justify-between items-center mb-6 text-lg font-bold">
                    <span>Total</span>
                    <span class="text-cyan-400 text-2xl">$<span id="total-price">0.00</span></span>
                </div>

                <button 
                    type="submit" 
                    form="booking-form"
                    id="checkout-btn"
                    disabled
                    class="w-full bg-gradient-to-r from-indigo-600 to-cyan-500 text-white py-3 rounded-lg font-bold hover:from-indigo-500 hover:to-cyan-400 transition shadow-lg shadow-indigo-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    Confirm Booking
                </button>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.seat-checkbox');
        const totalPriceEl = document.getElementById('total-price');
        const seatsDisplay = document.getElementById('seats-display');
        const noSeatsMsg = document.getElementById('no-seats-msg');
        const checkoutBtn = document.getElementById('checkout-btn');

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSummary);
        });

        function updateSummary() {
            let total = 0;
            let selectedSeats = [];

            checkboxes.forEach(cb => {
                if (cb.checked && !cb.disabled) {
                    const price = parseFloat(cb.dataset.price);
                    const label = cb.dataset.label;
                    total += price;
                    selectedSeats.push(label);
                }
            });

            // Update Price
            totalPriceEl.textContent = total.toFixed(2);

            // Update Visual List
            seatsDisplay.innerHTML = '';
            if (selectedSeats.length > 0) {
                noSeatsMsg.style.display = 'none';
                checkoutBtn.disabled = false;
                
                selectedSeats.forEach(seat => {
                    const badge = document.createElement('span');
                    badge.className = 'bg-gray-700 text-cyan-300 text-xs px-2 py-1 rounded border border-gray-600';
                    badge.textContent = seat;
                    seatsDisplay.appendChild(badge);
                });
            } else {
                noSeatsMsg.style.display = 'block';
                checkoutBtn.disabled = true;
            }
        }
    });
</script>
{% endblock %}